
# Run the accelerate command with manually set variables
accelerate launch \
    --use_deepspeed \
    --deepspeed_hostfile="$MLP_MPI_HOSTFILE" \
    --num_processes="$MLP_MPI_NP" \
    --num_machines="$MLP_WORKER_NUM" \
    --machine_rank="$MLP_ROLE_INDEX" \
    --main_process_ip="$MLP_WORKER_0_HOST" \
    --main_process_port="$MLP_WORKER_0_PORT" \
    --dynamo_backend=no \
    --mixed_precision=bf16 \
    --deepspeed_config_file="config/zero_stage2_config.json" \
    scripts/train.py \
    --pretrained_model_name_or_path="$MODEL_NAME" \
    --train_data_dir="$DATASET_NAME" \
    --train_data_meta="$DATASET_META_NAME" \
    --config_path=config/easyanimate_video_v5.1_magvit_qwen.yaml \
    --image_sample_size=1024 \
    --video_sample_size=256 \
    --token_sample_size=512 \
    --video_sample_stride=2 \
    --video_sample_n_frames=49 \
    --train_batch_size=1 \
    --video_repeat=1 \
    --gradient_accumulation_steps=1 \
    --dataloader_num_workers=8 \
    --num_train_epochs=100 \
    --checkpointing_steps=100 \
    --learning_rate=2e-05 \
    --lr_scheduler=constant_with_warmup \
    --lr_warmup_steps=100 \
    --seed=42 \
    --output_dir=output_dir \
    --gradient_checkpointing \
    --adam_weight_decay=5e-2 \
    --adam_epsilon=1e-10 \
    --vae_mini_batch=1 \
    --max_grad_norm=0.05 \
    --random_hw_adapt \
    --training_with_video_token_length \
    --loss_type=flow \
    --enable_bucket \
    --uniform_sampling \
    --train_mode=inpaint \
    --use_deepspeed \
    --low_vram \
    --trainable_modules="."
